

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>antipasti.preprocessing.preprocessing &mdash; ANTIPASTI 1.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=61243dd2"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            ANTIPASTI
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/index.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../citing.html">Citing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../publication.html">Related published work</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/antipasti.html">Autogenerated Full API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ANTIPASTI</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">antipasti.preprocessing.preprocessing</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for antipasti.preprocessing.preprocessing</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sa">r</span><span class="sd">&quot;&quot;&quot;This module contains the pre-processing class. </span>

<span class="sd">:Authors:   Kevin Michalewicz &lt;k.michalewicz22@imperial.ac.uk&gt;</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">DATA_DIR</span><span class="p">,</span> <span class="n">SCRIPTS_DIR</span><span class="p">,</span> <span class="n">STRUCTURES_DIR</span>
<span class="kn">from</span> <span class="nn">utils.generic_utils</span> <span class="kn">import</span> <span class="n">remove_abc</span>

<div class="viewcode-block" id="Preprocessing">
<a class="viewcode-back" href="../../../apidoc/antipasti.preprocessing.html#antipasti.preprocessing.preprocessing.Preprocessing">[docs]</a>
<span class="k">class</span> <span class="nc">Preprocessing</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Generating the residue normal mode correlation maps.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_path: str</span>
<span class="sd">        Path to the data folder.</span>
<span class="sd">    scripts_path: str</span>
<span class="sd">        Path to the scripts folder.</span>
<span class="sd">    structures_path: str</span>
<span class="sd">        Path to the PDB files.</span>
<span class="sd">    df: str</span>
<span class="sd">        Name of the database containing the PDB entries.</span>
<span class="sd">    modes: int</span>
<span class="sd">        Number of considered normal modes.</span>
<span class="sd">    chain_lengths_path: str</span>
<span class="sd">        Path to the folder containing arrays with the chain lengths.</span>
<span class="sd">    dccm_map_path: str</span>
<span class="sd">        Path to the normal mode correlation maps.</span>
<span class="sd">    residues_path: str</span>
<span class="sd">        Path to the folder containing the list of residues per entry.</span>
<span class="sd">    file_type_input: str</span>
<span class="sd">        Filename extension of input structures.</span>
<span class="sd">    selection: str</span>
<span class="sd">        Considered portion of antibody chains.</span>
<span class="sd">    pathological: list </span>
<span class="sd">        PDB identifiers of antibodies that need to be excluded.</span>
<span class="sd">    renew_maps: bool</span>
<span class="sd">        Compute all the normal mode correlation maps.</span>
<span class="sd">    renew_residues: bool</span>
<span class="sd">        Retrieve the lists of residues for each entry.</span>
<span class="sd">    cmaps: bool</span>
<span class="sd">        If ``True``, ANTIPASTI computes the contact maps of the complexes instead of the Normal Modes.</span>
<span class="sd">    cmaps_thr: float</span>
<span class="sd">        Thresholding distance for alpha (Î±) carbons to build the contact maps.</span>
<span class="sd">    ag_agnostic: bool</span>
<span class="sd">        If ``True``, Normal Mode correlation maps are computed in complete absence of the antigen.</span>
<span class="sd">    affinity_entries_only: bool</span>
<span class="sd">        This is ``False`` in general, but the ANTIPASTI pipeline could be used to other types of projects and thus consider data without affinity values.</span>
<span class="sd">    stage: str</span>
<span class="sd">        Choose between ``training`` and ``predicting``.</span>
<span class="sd">    test_data_path: str</span>
<span class="sd">        Path to the test data folder.</span>
<span class="sd">    test_dccm_map_path: str</span>
<span class="sd">        Path to the test normal mode correlation maps.</span>
<span class="sd">    test_residues_path: str</span>
<span class="sd">        Path to the folder containing the list of residues for a test sample.</span>
<span class="sd">    test_structures_path: str</span>
<span class="sd">        Path to the test PDB file.</span>
<span class="sd">    test_pdb_id: str</span>
<span class="sd">        Test PDB ID.</span>
<span class="sd">    alphafold: bool</span>
<span class="sd">        ``True`` the test structure was folded using ``AlphaFold``.</span>
<span class="sd">    h_offset: int</span>
<span class="sd">        Amount of absent residues between positions 1 and 25 in the heavy chain.</span>
<span class="sd">    l_offset: int</span>
<span class="sd">        Amount of absent residues between positions 1 and 23 in the light chain.</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">data_path</span><span class="o">=</span><span class="n">DATA_DIR</span><span class="p">,</span>
            <span class="n">scripts_path</span><span class="o">=</span><span class="n">SCRIPTS_DIR</span><span class="p">,</span>
            <span class="n">structures_path</span><span class="o">=</span><span class="n">STRUCTURES_DIR</span><span class="p">,</span>
            <span class="n">df</span><span class="o">=</span><span class="s1">&#39;sabdab_summary_all.tsv&#39;</span><span class="p">,</span>
            <span class="n">modes</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
            <span class="n">chain_lengths_path</span><span class="o">=</span><span class="s1">&#39;chain_lengths/&#39;</span><span class="p">,</span>
            <span class="n">dccm_map_path</span><span class="o">=</span><span class="s1">&#39;dccm_maps/&#39;</span><span class="p">,</span>
            <span class="n">residues_path</span><span class="o">=</span><span class="s1">&#39;lists_of_residues/&#39;</span><span class="p">,</span>
            <span class="n">file_type_input</span><span class="o">=</span><span class="s1">&#39;.pdb&#39;</span><span class="p">,</span>
            <span class="n">selection</span><span class="o">=</span><span class="s1">&#39;_fv&#39;</span><span class="p">,</span>
            <span class="n">pathological</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">renew_maps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">renew_residues</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">cmaps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">cmaps_thr</span><span class="o">=</span><span class="mf">8.0</span><span class="p">,</span>
            <span class="n">ag_agnostic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">affinity_entries_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">stage</span><span class="o">=</span><span class="s1">&#39;training&#39;</span><span class="p">,</span>
            <span class="n">test_data_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">test_dccm_map_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">test_residues_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">test_structure_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">test_pdb_id</span><span class="o">=</span><span class="s1">&#39;1t66&#39;</span><span class="p">,</span>
            <span class="n">alphafold</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">h_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">l_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">ag_residues</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">=</span> <span class="n">data_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scripts_path</span> <span class="o">=</span> <span class="n">scripts_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structures_path</span> <span class="o">=</span> <span class="n">structures_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain_lengths_path</span> <span class="o">=</span> <span class="n">data_path</span> <span class="o">+</span> <span class="n">chain_lengths_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dccm_map_path</span> <span class="o">=</span> <span class="n">data_path</span> <span class="o">+</span> <span class="n">dccm_map_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residues_path</span> <span class="o">=</span> <span class="n">data_path</span> <span class="o">+</span> <span class="n">residues_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modes</span> <span class="o">=</span> <span class="n">modes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_type_input</span> <span class="o">=</span> <span class="n">file_type_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pathological</span> <span class="o">=</span> <span class="n">pathological</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span> <span class="o">=</span> <span class="n">cmaps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmaps_thr</span> <span class="o">=</span> <span class="n">cmaps_thr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ag_agnostic</span> <span class="o">=</span> <span class="n">ag_agnostic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">affinity_entries_only</span> <span class="o">=</span> <span class="n">affinity_entries_only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="o">=</span> <span class="s1">&#39;training&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_residues_paths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residues_path</span><span class="p">,</span> <span class="s1">&#39;*.npy&#39;</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alphafold</span> <span class="o">=</span> <span class="n">alphafold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_offset</span> <span class="o">=</span> <span class="n">h_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_offset</span> <span class="o">=</span> <span class="n">l_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ag_residues</span> <span class="o">=</span> <span class="n">ag_residues</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_path</span> <span class="o">=</span> <span class="n">data_path</span> <span class="o">+</span> <span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">affinity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_df</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heavy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">light</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialisation</span><span class="p">(</span><span class="n">renew_maps</span><span class="p">,</span> <span class="n">renew_residues</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_res_list_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_res_list_l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_res_list_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_res_list_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_max_min_chains</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_imgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_training_images</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">stage</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="o">!=</span> <span class="s1">&#39;training&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_data_path</span> <span class="o">=</span> <span class="n">test_data_path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_dccm_map_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_data_path</span> <span class="o">+</span> <span class="n">test_dccm_map_path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_residues_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_data_path</span> <span class="o">+</span> <span class="n">test_residues_path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_structure_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_data_path</span> <span class="o">+</span> <span class="n">test_structure_path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_pdb_id</span> <span class="o">=</span> <span class="n">test_pdb_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_test_image</span><span class="p">()</span>


<div class="viewcode-block" id="Preprocessing.clean_df">
<a class="viewcode-back" href="../../../apidoc/antipasti.preprocessing.html#antipasti.preprocessing.preprocessing.Preprocessing.clean_df">[docs]</a>
    <span class="k">def</span> <span class="nf">clean_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Cleans the database containing the PDB entries.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df_pdbs: list</span>
<span class="sd">            PDB entries.</span>
<span class="sd">        df_kds: list </span>
<span class="sd">            Binding affinities.</span>
<span class="sd">        df: pandas.DataFrame</span>
<span class="sd">            Cleaned database.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)[[</span><span class="s1">&#39;pdb&#39;</span><span class="p">,</span> <span class="s1">&#39;antigen_type&#39;</span><span class="p">,</span> <span class="s1">&#39;affinity&#39;</span><span class="p">]]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="s1">&#39;pdb&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pdb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pdb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="c1"># lowercase and remove &#39;+&#39; signs of scientific notation</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">antigen_type</span><span class="o">.</span><span class="n">notna</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">antigen_type</span> <span class="o">!=</span> <span class="s1">&#39;NA&#39;</span><span class="p">)][[</span><span class="s1">&#39;pdb&#39;</span><span class="p">,</span> <span class="s1">&#39;affinity&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">affinity_entries_only</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">affinity</span><span class="o">.</span><span class="n">notna</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">affinity</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">)]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pdb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pathological</span><span class="p">)]</span> <span class="c1"># Removing pathological cases </span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pdb&#39;</span><span class="p">]),</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;affinity&#39;</span><span class="p">]),</span> <span class="n">df</span></div>


<div class="viewcode-block" id="Preprocessing.generate_fv_pdb">
<a class="viewcode-back" href="../../../apidoc/antipasti.preprocessing.html#antipasti.preprocessing.preprocessing.Preprocessing.generate_fv_pdb">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_fv_pdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">keepABC</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lresidues</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hupsymchain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lupsymchain</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Generates a new PDB file containing the antigen residues and the antibody variable region.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path: str</span>
<span class="sd">            Path of a Chothia-numbered PDB file.</span>
<span class="sd">        keepABC: bool</span>
<span class="sd">            Keeps residues whose name ends with a letter from &#39;A&#39; to &#39;Z&#39;.</span>
<span class="sd">        lresidues: bool</span>
<span class="sd">            The names of each residue are stored in ``self.residues_path``.</span>
<span class="sd">        upsymchain: int</span>
<span class="sd">            Upper limit of heavy chain residues due to a change in the numbering convention. Only useful when using ``AlphaFold``.</span>
<span class="sd">        lupsymchain: int</span>
<span class="sd">            Upper limit of light chain residues due to a change in the numbering convention. Only useful when using ``AlphaFold``.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">amino_acid_dictionary</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;CYS&#39;</span><span class="p">:</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;ASP&#39;</span><span class="p">:</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;SER&#39;</span><span class="p">:</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;GLN&#39;</span><span class="p">:</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;LYS&#39;</span><span class="p">:</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ILE&#39;</span><span class="p">:</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;PRO&#39;</span><span class="p">:</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;THR&#39;</span><span class="p">:</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;PHE&#39;</span><span class="p">:</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;ASN&#39;</span><span class="p">:</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;GLY&#39;</span><span class="p">:</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;HIS&#39;</span><span class="p">:</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;LEU&#39;</span><span class="p">:</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;ARG&#39;</span><span class="p">:</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;TRP&#39;</span><span class="p">:</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;ALA&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;VAL&#39;</span><span class="p">:</span><span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;GLU&#39;</span><span class="p">:</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;TYR&#39;</span><span class="p">:</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;MET&#39;</span><span class="p">:</span> <span class="s1">&#39;M&#39;</span><span class="p">}</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="o">==</span> <span class="s1">&#39;training&#39;</span><span class="p">:</span>
            <span class="n">rpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_residues_path</span>
        <span class="n">list_residues</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;START-Ab&#39;</span><span class="p">]</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="c1"># needs to be Chothia-numbered</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">header_lines_important</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">header_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">content</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;R&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">))]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">h_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">114</span><span class="p">)</span>
            <span class="n">l_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">108</span><span class="p">)</span>
            <span class="n">residue_type_range</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
            <span class="n">start_chain</span> <span class="o">=</span> <span class="mi">21</span>
            <span class="n">chain_range</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start_chain</span><span class="p">,</span> <span class="n">start_chain</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">res_range</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span>
            <span class="n">res_extra_letter</span> <span class="o">=</span> <span class="mi">26</span> <span class="c1">#sometimes includes a letter &#39;A&#39;, &#39;B&#39;, &#39;C&#39;, ...</span>
            <span class="n">h_chain_key</span> <span class="o">=</span> <span class="s1">&#39;HCHAIN&#39;</span>
            <span class="n">l_chain_key</span> <span class="o">=</span> <span class="s1">&#39;LCHAIN&#39;</span>
            <span class="n">antigen_chain_key</span> <span class="o">=</span> <span class="s1">&#39;AGCHAIN&#39;</span>
            <span class="n">idx_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">header_lines_important</span><span class="p">)</span>
            <span class="n">idx_list_l</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">idx_list_antigen</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">antigen_chains</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">new_path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span> <span class="o">+</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span>
            <span class="c1"># Getting the names of the heavy and antigen chains</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="n">header_lines_important</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">h_chain_key</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">h_pos</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">h_chain_key</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">h_chain_key</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">h_chain</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">h_pos</span><span class="p">:</span><span class="n">h_pos</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">antigen_pos</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">antigen_chain_key</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">antigen_chain_key</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">antigen_chains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">antigen_pos</span><span class="p">:</span><span class="n">antigen_pos</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="n">antigen_pos</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;;&#39;</span><span class="p">]:</span>
                        <span class="n">antigen_chains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">antigen_pos</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="c1"># If two (or more) interacting antigen chains present</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># useful when using AlphaFold</span>
                <span class="n">h_chain</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span> 
                <span class="n">l_chain</span> <span class="o">=</span> <span class="s1">&#39;B&#39;</span>
                <span class="n">antigen_chains</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">]</span>
                <span class="n">idx_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">h_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_offset</span><span class="p">,</span> <span class="n">hupsymchain</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">h_offset</span><span class="p">)</span>
                <span class="n">l_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">l_offset</span><span class="p">,</span> <span class="n">lupsymchain</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">l_offset</span><span class="p">)</span>
                <span class="n">h_pos</span> <span class="o">=</span> <span class="n">start_chain</span>
                <span class="n">l_pos</span> <span class="o">=</span> <span class="n">start_chain</span>

            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">l_chain_key</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">l_pos</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">l_chain_key</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_chain_key</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">l_chain</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">l_pos</span><span class="p">:</span><span class="n">l_pos</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphafold</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> 
                <span class="n">l_chain</span> <span class="o">=</span> <span class="kc">None</span>
                
            <span class="c1"># Checking if H and L chains have the same name</span>
            <span class="k">if</span> <span class="n">l_chain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">h_chain</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">l_chain</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                <span class="n">pathologic</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">h_chain</span> <span class="o">=</span> <span class="n">h_chain</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="n">l_chain</span> <span class="o">=</span> <span class="n">h_chain</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">antigen_chains</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">affinity_entries_only</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="p">(</span><span class="n">h_chain</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">antigen_chains</span> <span class="ow">or</span> <span class="p">(</span><span class="n">l_chain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">l_chain</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">antigen_chains</span><span class="p">)):</span>
                <span class="n">pathologic</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">h_chain</span> <span class="o">=</span> <span class="n">h_chain</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">l_chain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">l_chain</span> <span class="o">=</span> <span class="n">l_chain</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pathologic</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Checks for matching identifiers</span>
            <span class="k">if</span> <span class="n">pathologic</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;X&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">antigen_chains</span><span class="p">:</span>
                    <span class="n">new_hchain</span> <span class="o">=</span> <span class="s1">&#39;X&#39;</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">new_hchain</span> <span class="o">=</span> <span class="s1">&#39;W&#39;</span>
                <span class="k">if</span> <span class="s1">&#39;Y&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">antigen_chains</span><span class="p">:</span>
                    <span class="n">new_lchain</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">new_lchain</span> <span class="o">=</span> <span class="s1">&#39;Z&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_hchain</span> <span class="o">=</span> <span class="n">h_chain</span>
                <span class="n">new_lchain</span> <span class="o">=</span> <span class="n">l_chain</span>   
                           
            <span class="c1"># Obtaining lines for the heavy chain variable region first</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="n">header_lines</span><span class="p">:]):</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="n">chain_range</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">h_chain</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">res_range</span><span class="p">])</span> <span class="ow">in</span> <span class="n">h_range</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">res_extra_letter</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39; &#39;</span> <span class="ow">or</span> <span class="n">keepABC</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;HETATM&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">idx_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">header_lines</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">lresidues</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">full_res</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">res_range</span><span class="p">]</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="n">res_extra_letter</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">pathologic</span><span class="p">:</span>
                                <span class="n">full_res</span> <span class="o">=</span> <span class="n">new_hchain</span> <span class="o">+</span> <span class="n">full_res</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">full_res</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">chain_range</span><span class="p">]</span> <span class="o">+</span> <span class="n">full_res</span>
                            <span class="n">full_res</span> <span class="o">=</span> <span class="n">amino_acid_dictionary</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">residue_type_range</span><span class="p">]]</span> <span class="o">+</span> <span class="n">full_res</span>
                            <span class="k">if</span> <span class="n">full_res</span> <span class="o">!=</span> <span class="n">list_residues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                                <span class="n">list_residues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_res</span><span class="p">)</span>

            <span class="c1"># This separation ensures that heavy chain residues are enlisted first</span>
            <span class="k">if</span> <span class="n">l_chain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="n">header_lines</span><span class="p">:]):</span>
                    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="n">chain_range</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">l_chain</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">res_range</span><span class="p">])</span> <span class="ow">in</span> <span class="n">l_range</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">res_extra_letter</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39; &#39;</span> <span class="ow">or</span> <span class="n">keepABC</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;HETATM&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">idx_list_l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">header_lines</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">lresidues</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                                <span class="n">full_res</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">res_range</span><span class="p">]</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="n">res_extra_letter</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">pathologic</span><span class="p">:</span>
                                    <span class="n">full_res</span> <span class="o">=</span> <span class="n">new_lchain</span> <span class="o">+</span> <span class="n">full_res</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">full_res</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">chain_range</span><span class="p">]</span> <span class="o">+</span> <span class="n">full_res</span>
                                <span class="n">full_res</span> <span class="o">=</span> <span class="n">amino_acid_dictionary</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">residue_type_range</span><span class="p">]]</span> <span class="o">+</span> <span class="n">full_res</span>
                                <span class="k">if</span> <span class="n">full_res</span> <span class="o">!=</span> <span class="n">list_residues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                                    <span class="n">list_residues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_res</span><span class="p">)</span>                   
        
            <span class="k">if</span> <span class="n">lresidues</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">list_residues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;END-Ab&#39;</span><span class="p">)</span>

            <span class="c1"># Obtaining antigen(s)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="n">header_lines</span><span class="p">:]):</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">chain_range</span><span class="p">]</span> <span class="ow">in</span> <span class="n">agc</span> <span class="k">for</span> <span class="n">agc</span> <span class="ow">in</span> <span class="n">antigen_chains</span><span class="p">)</span> <span class="ow">and</span> <span class="n">h_chain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">antigen_chains</span> <span class="ow">and</span> <span class="n">l_chain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">antigen_chains</span><span class="p">:</span>
                    <span class="n">idx_list_antigen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">header_lines</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">lresidues</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">full_res</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">chain_range</span><span class="p">]</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="n">res_range</span><span class="p">]</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="n">res_extra_letter</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="n">residue_type_range</span><span class="p">]</span> <span class="ow">in</span> <span class="n">amino_acid_dictionary</span><span class="p">:</span>
                            <span class="n">full_res</span> <span class="o">=</span> <span class="n">amino_acid_dictionary</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">residue_type_range</span><span class="p">]]</span> <span class="o">+</span> <span class="n">full_res</span>
                            <span class="k">if</span> <span class="n">full_res</span> <span class="o">!=</span> <span class="n">list_residues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                                <span class="n">list_residues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_res</span><span class="p">)</span>    

        <span class="c1"># List with name of every residue is saved if selected</span>
            <span class="n">saving_path</span> <span class="o">=</span> <span class="n">rpath</span> <span class="o">+</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.npy&#39;</span>
            <span class="c1">#if not os.path.exists(saving_path):</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">saving_path</span><span class="p">,</span> <span class="n">list_residues</span><span class="p">)</span>
            
        <span class="c1"># Creating new file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">new_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_new</span><span class="p">:</span>
            <span class="n">f_new</span><span class="o">.</span><span class="n">writelines</span><span class="p">([</span><span class="n">content</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">idx_list</span><span class="p">[:</span><span class="n">header_lines_important</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]])</span>
            <span class="k">if</span> <span class="n">l_chain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphafold</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">f_new</span><span class="o">.</span><span class="n">writelines</span><span class="p">([</span><span class="n">content</span><span class="p">[</span><span class="n">l</span><span class="p">][:</span><span class="n">h_pos</span><span class="p">]</span><span class="o">+</span><span class="n">new_hchain</span><span class="o">+</span><span class="n">content</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">h_pos</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">l_pos</span><span class="p">]</span><span class="o">+</span><span class="n">new_lchain</span><span class="o">+</span><span class="n">content</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">l_pos</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">idx_list</span><span class="p">[</span><span class="n">header_lines_important</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span><span class="n">header_lines_important</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f_new</span><span class="o">.</span><span class="n">writelines</span><span class="p">([</span><span class="n">content</span><span class="p">[</span><span class="n">l</span><span class="p">][:</span><span class="n">h_pos</span><span class="p">]</span><span class="o">+</span><span class="n">new_hchain</span><span class="o">+</span><span class="n">content</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">h_pos</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">idx_list</span><span class="p">[</span><span class="n">header_lines_important</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span><span class="n">header_lines_important</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">f_new</span><span class="o">.</span><span class="n">writelines</span><span class="p">([</span><span class="n">content</span><span class="p">[</span><span class="n">l</span><span class="p">][:</span><span class="n">start_chain</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">content</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">start_chain</span><span class="o">-</span><span class="mi">4</span><span class="p">:</span><span class="n">start_chain</span><span class="p">]</span><span class="o">+</span><span class="n">new_hchain</span><span class="o">+</span><span class="n">content</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">start_chain</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">idx_list</span><span class="p">[</span><span class="n">header_lines_important</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:]])</span>
            <span class="k">if</span> <span class="n">l_chain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">f_new</span><span class="o">.</span><span class="n">writelines</span><span class="p">([</span><span class="n">content</span><span class="p">[</span><span class="n">l</span><span class="p">][:</span><span class="n">start_chain</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">content</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">start_chain</span><span class="o">-</span><span class="mi">4</span><span class="p">:</span><span class="n">start_chain</span><span class="p">]</span><span class="o">+</span><span class="n">new_lchain</span><span class="o">+</span><span class="n">content</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">start_chain</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">idx_list_l</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ag_agnostic</span><span class="p">:</span>
                <span class="n">f_new</span><span class="o">.</span><span class="n">writelines</span><span class="p">([</span><span class="n">content</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">idx_list_antigen</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">:</span>
                <span class="n">f_new</span><span class="o">.</span><span class="n">writelines</span><span class="p">([</span><span class="n">content</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">))</span> <span class="k">if</span> <span class="n">content</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;HETATM&#39;</span> <span class="ow">and</span> <span class="n">content</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">chain_range</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">h_chain</span><span class="p">,</span> <span class="n">l_chain</span><span class="p">]</span> <span class="ow">and</span> <span class="n">l</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">idx_list</span><span class="o">+</span><span class="n">idx_list_l</span><span class="o">+</span><span class="n">idx_list_antigen</span><span class="p">])</span></div>

            
<div class="viewcode-block" id="Preprocessing.generate_maps">
<a class="viewcode-back" href="../../../apidoc/antipasti.preprocessing.html#antipasti.preprocessing.preprocessing.Preprocessing.generate_maps">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Generates the Normal Mode correlation maps.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">):</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">entry</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structures_path</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_type_input</span>
            <span class="n">new_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dccm_map_path</span> <span class="o">+</span> <span class="n">entry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generate_fv_pdb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structures_path</span><span class="o">+</span><span class="n">entry</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">file_type_input</span><span class="p">,</span> <span class="n">lresidues</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">:</span> <span class="c1"># and len(np.load(self.residues_path + path[-11:-7] + &#39;.npy&#39;)) &gt; 500:</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s1">&#39;/usr/local/bin/RScript&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scripts_path</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;pdb_to_dccm.r&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_path</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)],</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span>
            <span class="c1">#elif not self.cmaps:</span>
            <span class="c1">#    print(path[-11:-7])</span>
            <span class="c1">#    subprocess.call([&#39;/usr/local/bin/RScript&#39;, str(self.scripts_path)+&#39;pdb_to_dccm_aa.r&#39;, str(path), str(new_path), str(self.modes)], stdout=open(os.devnull, &#39;wb&#39;))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scripts_path</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;generate_contact_maps.py&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_path</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmaps_thr</span><span class="p">)],</span> <span class="n">stdout</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">25</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Map &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; out of &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; processed.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Preprocessing.get_lists_of_lengths">
<a class="viewcode-back" href="../../../apidoc/antipasti.preprocessing.html#antipasti.preprocessing.preprocessing.Preprocessing.get_lists_of_lengths">[docs]</a>
    <span class="k">def</span> <span class="nf">get_lists_of_lengths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selected_entries</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Retrieves lists with the lengths of the heavy and light chains.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        selected_entries: list</span>
<span class="sd">            PDB valid entries.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        heavy: list</span>
<span class="sd">            Lengths of the heavy chains. In the context of the prediction stage, this list has one element.</span>
<span class="sd">        light: list </span>
<span class="sd">            Lengths of the light chains. In the context of the prediction stage, this list has one element.</span>
<span class="sd">        selected_entries: list</span>
<span class="sd">            PDB valid entries. In the context of the prediction stage, this list has one element.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">heavy</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">light</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="o">==</span> <span class="s1">&#39;training&#39;</span><span class="p">:</span>
            <span class="n">rpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_residues_path</span>

        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">selected_entries</span><span class="p">:</span>
            <span class="n">list_of_residues</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">rpath</span><span class="o">+</span><span class="n">entry</span><span class="o">+</span><span class="s1">&#39;.npy&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">chain_pos</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="s1">&#39;END-Ab&#39;</span> <span class="ow">in</span> <span class="n">list_of_residues</span><span class="p">:</span>
                <span class="n">list_of_residues</span> <span class="o">=</span> <span class="n">list_of_residues</span><span class="p">[:</span><span class="n">list_of_residues</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;END-Ab&#39;</span><span class="p">)]</span>
                <span class="n">chain_pos</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">list_of_residues</span> <span class="o">=</span> <span class="n">list_of_residues</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">h_chain</span> <span class="o">=</span> <span class="n">list_of_residues</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">chain_pos</span><span class="p">]</span>
            <span class="n">l_chain</span> <span class="o">=</span> <span class="n">list_of_residues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">chain_pos</span><span class="p">]</span>

            <span class="n">heavy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">([</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">list_of_residues</span> <span class="k">if</span> <span class="n">idx</span><span class="p">[</span><span class="n">chain_pos</span><span class="p">]</span> <span class="o">==</span> <span class="n">h_chain</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">h_chain</span> <span class="o">!=</span> <span class="n">l_chain</span><span class="p">:</span>
                <span class="n">light</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">([</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">list_of_residues</span> <span class="k">if</span> <span class="n">idx</span><span class="p">[</span><span class="n">chain_pos</span><span class="p">]</span> <span class="o">==</span> <span class="n">l_chain</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">light</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">heavy</span><span class="p">,</span> <span class="n">light</span><span class="p">,</span> <span class="n">selected_entries</span></div>


<div class="viewcode-block" id="Preprocessing.get_max_min_chains">
<a class="viewcode-back" href="../../../apidoc/antipasti.preprocessing.html#antipasti.preprocessing.preprocessing.Preprocessing.get_max_min_chains">[docs]</a>
    <span class="k">def</span> <span class="nf">get_max_min_chains</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Returns the longest and shortest possible chains.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_res_list_h</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">max_res_list_l</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_residues_paths</span><span class="p">:</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="s1">&#39;END-Ab&#39;</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="n">shift</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entries</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">current_list_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">heavy</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">current_list_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">heavy</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">heavy</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">light</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">current_list_h</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">shift</span><span class="p">:]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">current_list_h</span><span class="p">]</span>
            <span class="n">current_list_l</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">shift</span><span class="p">:]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">current_list_l</span><span class="p">]</span>
            <span class="n">max_res_list_h</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">current_list_h</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">max_res_list_h</span><span class="p">))</span>
            <span class="n">max_res_list_l</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">current_list_l</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">max_res_list_l</span><span class="p">))</span>
            
        <span class="n">max_res_list_h</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">max_res_list_h</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">remove_abc</span><span class="p">)</span>
        <span class="n">min_res_list_h</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">max_res_list_h</span><span class="p">]))</span>
        <span class="n">max_res_list_h</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">max_res_list_h</span><span class="p">]</span>

        <span class="n">max_res_list_l</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">max_res_list_l</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">remove_abc</span><span class="p">)</span>
        <span class="n">min_res_list_l</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">max_res_list_l</span><span class="p">]))</span>
        <span class="n">max_res_list_l</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">max_res_list_l</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_residues_paths</span><span class="p">:</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="s1">&#39;END-Ab&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">shift</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entries</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">current_list_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">heavy</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">current_list_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">heavy</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">heavy</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">light</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">current_list_h</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">shift</span><span class="p">:]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">current_list_h</span><span class="p">]</span>
            <span class="n">current_list_l</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">shift</span><span class="p">:]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">current_list_l</span><span class="p">]</span>
            <span class="n">min_res_list_h</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">current_list_h</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">min_res_list_h</span><span class="p">)))</span>
            <span class="n">min_res_list_l</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">current_list_l</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">min_res_list_l</span><span class="p">)))</span>

        <span class="n">min_res_list_h</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">min_res_list_h</span><span class="p">]</span>
        <span class="n">min_res_list_l</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">min_res_list_l</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">max_res_list_h</span><span class="p">,</span> <span class="n">max_res_list_l</span><span class="p">,</span> <span class="n">min_res_list_h</span><span class="p">,</span> <span class="n">min_res_list_l</span></div>



<div class="viewcode-block" id="Preprocessing.initialisation">
<a class="viewcode-back" href="../../../apidoc/antipasti.preprocessing.html#antipasti.preprocessing.preprocessing.Preprocessing.initialisation">[docs]</a>
    <span class="k">def</span> <span class="nf">initialisation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">renew_maps</span><span class="p">,</span> <span class="n">renew_residues</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Computes the normal mode correlation maps and retrieves lists with the lengths of the heavy and light chains.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        renew_maps: bool</span>
<span class="sd">            Compute all the normal mode correlation maps.</span>
<span class="sd">        renew_residues: bool</span>
<span class="sd">            Retrieve the lists of residues for each entry.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        heavy: list</span>
<span class="sd">            Lengths of the heavy chains.</span>
<span class="sd">        light: list </span>
<span class="sd">            Lengths of the light chains.</span>
<span class="sd">        selected_entries: list</span>
<span class="sd">            PDB valid entries.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">renew_maps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generate_maps</span><span class="p">()</span>

        <span class="n">dccm_paths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dccm_map_path</span><span class="p">,</span> <span class="s1">&#39;*.npy&#39;</span><span class="p">)))</span>
        <span class="n">selected_entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">dccm_paths</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">8</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dccm_paths</span><span class="p">))]</span>

        <span class="k">if</span> <span class="n">renew_residues</span><span class="p">:</span>
            <span class="n">heavy</span><span class="p">,</span> <span class="n">light</span><span class="p">,</span> <span class="n">selected_entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lists_of_lengths</span><span class="p">(</span><span class="n">selected_entries</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_lengths_path</span><span class="o">+</span><span class="s1">&#39;heavy_lengths.npy&#39;</span><span class="p">,</span> <span class="n">heavy</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_lengths_path</span><span class="o">+</span><span class="s1">&#39;light_lengths.npy&#39;</span><span class="p">,</span> <span class="n">light</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_lengths_path</span><span class="o">+</span><span class="s1">&#39;selected_entries.npy&#39;</span><span class="p">,</span> <span class="n">selected_entries</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">heavy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_lengths_path</span><span class="o">+</span><span class="s1">&#39;heavy_lengths.npy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">light</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_lengths_path</span><span class="o">+</span><span class="s1">&#39;light_lengths.npy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_lengths_path</span><span class="o">+</span><span class="s1">&#39;selected_entries.npy&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="n">selected_entries</span>

        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">selected_entries</span><span class="p">:</span>
            <span class="n">residues</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residues_path</span><span class="o">+</span><span class="n">entry</span><span class="o">+</span><span class="s1">&#39;.npy&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;END-Ab&#39;</span> <span class="ow">in</span> <span class="n">residues</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">residues</span><span class="p">[:</span><span class="n">residues</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;END-Ab&#39;</span><span class="p">)])</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">heavy</span><span class="p">[</span><span class="n">selected_entries</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">entry</span><span class="p">)]</span> <span class="o">+</span> <span class="n">light</span><span class="p">[</span><span class="n">selected_entries</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">entry</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">heavy</span><span class="p">,</span> <span class="n">light</span><span class="p">,</span> <span class="n">selected_entries</span></div>


<div class="viewcode-block" id="Preprocessing.generate_masked_image">
<a class="viewcode-back" href="../../../apidoc/antipasti.preprocessing.html#antipasti.preprocessing.preprocessing.Preprocessing.generate_masked_image">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_masked_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">test_h</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">test_l</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Generates a masked normal mode correlation map</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        img: numpy.ndarray</span>
<span class="sd">            Original array containing no blank pixels.</span>
<span class="sd">        idx: int</span>
<span class="sd">            Input index.</span>
<span class="sd">        test_h: int</span>
<span class="sd">            Length of the heavy chain of an antibody in the test set.</span>
<span class="sd">        test_l: int</span>
<span class="sd">            Length of the light chain of an antibody in the test set.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        masked: numpy.ndarray</span>
<span class="sd">            Masked normal mode correlation map.</span>
<span class="sd">        mask: numpy.ndarray</span>
<span class="sd">            Mask itself.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="o">==</span> <span class="s1">&#39;training&#39;</span><span class="p">:</span>    
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_residues_paths</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphafold</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_residues_path</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">test_pdb_id</span><span class="o">+</span><span class="s1">&#39;.npy&#39;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_residues_path</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">test_pdb_id</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.npy&#39;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># removing &#39;_af&#39; suffix</span>
        <span class="n">antigen_max_pixels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ag_residues</span>
        <span class="n">f_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># We force unique elements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_res_list_h</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_res_list_h</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_res_list_l</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_res_list_l</span><span class="p">))</span>
        <span class="n">max_res_h</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_res_list_h</span><span class="p">)</span>
        <span class="n">max_res_l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_res_list_l</span><span class="p">)</span>
        <span class="n">max_res</span> <span class="o">=</span> <span class="n">max_res_h</span> <span class="o">+</span> <span class="n">max_res_l</span> 
        <span class="n">masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">max_res</span><span class="o">+</span><span class="n">antigen_max_pixels</span><span class="p">,</span> <span class="n">max_res</span><span class="o">+</span><span class="n">antigen_max_pixels</span><span class="p">))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">max_res</span><span class="o">+</span><span class="n">antigen_max_pixels</span><span class="p">,</span> <span class="n">max_res</span><span class="o">+</span><span class="n">antigen_max_pixels</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="o">!=</span> <span class="s1">&#39;training&#39;</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">test_h</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">test_l</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entries</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heavy</span><span class="p">[</span><span class="n">current_idx</span><span class="p">]</span>
            <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">light</span><span class="p">[</span><span class="n">current_idx</span><span class="p">]</span>

        <span class="n">current_list_h</span> <span class="o">=</span> <span class="n">f_res</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">h</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">f_res</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="n">f_res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)])</span>
        <span class="n">current_list_h</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">shift</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">current_list_h</span><span class="p">]</span> <span class="c1"># First letter is the type of amino acid and second letter is the chain ID</span>
        <span class="n">current_list_l</span> <span class="o">=</span> <span class="n">f_res</span><span class="p">[</span><span class="n">h</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">h</span><span class="o">+</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">current_list_l</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">shift</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">current_list_l</span><span class="p">]</span>    

        <span class="n">idx_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_res_h</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_res_list_h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">current_list_h</span><span class="p">]</span>
        <span class="n">idx_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">max_res_h</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_res_l</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_res_list_l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">current_list_l</span><span class="p">]</span>
        <span class="n">idx_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">max_res_h</span><span class="o">+</span><span class="n">max_res_l</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">antigen_max_pixels</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">h</span><span class="o">+</span><span class="n">l</span><span class="p">)))]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idx_list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idx_list</span><span class="p">):</span>
                <span class="n">masked</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span>
                <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            
        <span class="k">return</span> <span class="n">masked</span><span class="p">,</span> <span class="n">mask</span></div>


<div class="viewcode-block" id="Preprocessing.load_training_images">
<a class="viewcode-back" href="../../../apidoc/antipasti.preprocessing.html#antipasti.preprocessing.preprocessing.Preprocessing.load_training_images">[docs]</a>
    <span class="k">def</span> <span class="nf">load_training_images</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Returns the input/output pairs of the model and their corresponding labels.</span>

<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>      
        <span class="n">imgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">raw_imgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">kds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">file_paths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dccm_map_path</span><span class="p">,</span> <span class="s1">&#39;*.npy&#39;</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">:</span>
            <span class="n">pdb_id</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pdb_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entries</span> <span class="ow">and</span> <span class="n">pdb_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pathological</span><span class="p">:</span>
                <span class="n">raw_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pdb_id</span><span class="p">)</span>
                <span class="n">idx_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entries</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pdb_id</span><span class="p">)</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pdb_id</span><span class="p">)</span>
                <span class="n">raw_imgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">raw_sample</span><span class="p">)</span>
                <span class="n">imgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_masked_image</span><span class="p">(</span><span class="n">raw_sample</span><span class="p">,</span> <span class="n">idx_new</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">affinity_entries_only</span><span class="p">:</span>
                    <span class="n">kds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">affinity</span><span class="p">[</span><span class="n">idx</span><span class="p">])))</span>

        <span class="k">assert</span> <span class="n">labels</span> <span class="o">==</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entries</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pathological</span><span class="p">]</span>

        <span class="c1">#for pdb in self.selected_entries:</span>
        <span class="c1">#    if pdb not in self.pathological and self.affinity_entries_only:</span>
        <span class="c1">#        assert np.float16(10**kds[[item for item in self.selected_entries if item not in self.pathological].index(pdb)] == np.float16(self.df[self.df[&#39;pdb&#39;]==pdb][&#39;affinity&#39;])).all()</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">imgs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">kds</span><span class="p">),</span> <span class="n">labels</span><span class="p">,</span> <span class="n">raw_imgs</span></div>


<div class="viewcode-block" id="Preprocessing.load_test_image">
<a class="viewcode-back" href="../../../apidoc/antipasti.preprocessing.html#antipasti.preprocessing.preprocessing.Preprocessing.load_test_image">[docs]</a>
    <span class="k">def</span> <span class="nf">load_test_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Returns a test normal mode correlation map which is masked according to the existing residues in the training set.</span>

<span class="sd">        &quot;&quot;&quot;</span>  
        <span class="n">pdb_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_pdb_id</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphafold</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lists_of_lengths</span><span class="p">(</span><span class="n">selected_entries</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">pdb_id</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
            <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
            <span class="n">hupsymchain</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">h</span> 
            <span class="n">lupsymchain</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">l</span> 
            <span class="n">lresidues</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hupsymchain</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">lupsymchain</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">lresidues</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Generating the normal mode correlation map</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">pdb_id</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_structure_path</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_type_input</span>
        <span class="n">new_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_dccm_map_path</span> <span class="o">+</span> <span class="n">pdb_id</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_fv_pdb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_structure_path</span><span class="o">+</span><span class="n">pdb_id</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">file_type_input</span><span class="p">,</span> <span class="n">lresidues</span><span class="o">=</span><span class="n">lresidues</span><span class="p">,</span> <span class="n">hupsymchain</span><span class="o">=</span><span class="n">hupsymchain</span><span class="p">,</span> <span class="n">lupsymchain</span><span class="o">=</span><span class="n">lupsymchain</span><span class="p">)</span> 
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s1">&#39;/usr/local/bin/RScript &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scripts_path</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;pdb_to_dccm.r &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">new_path</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)],</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c1"># Getting lengths, residues and masking</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_dccm_map_path</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="o">+</span><span class="n">pdb_id</span><span class="o">+</span><span class="s1">&#39;.npy&#39;</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_path</span><span class="p">:</span>
            <span class="n">raw_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphafold</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lists_of_lengths</span><span class="p">(</span><span class="n">selected_entries</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">pdb_id</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_masked_image</span><span class="p">(</span><span class="n">raw_sample</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">test_h</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">),</span> <span class="n">test_l</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Kevin Michalewicz et al.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>